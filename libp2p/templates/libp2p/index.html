{% extends 'base.html' %}
{% block title %}js-libp2p demo{% endblock %}
{% block sw_url %}{% url "libp2p:sw.js" %}{% endblock %}
{% block container %}
  <header>
    <h1 id="status">Starting libp2p...</h1>
  </header>
  <main>
    <input type="text" id="peer"/>
    <input type="text" id="content"/>
    <button type="submit" onclick="
      dailing(
        document.querySelector('#peer').value,
        document.querySelector('#content').value)
    ">say hi</button>
  </main>
{% endblock %}
{% block script %}
  <script src="https://wzrd.in/standalone/libp2p@0.29.3"></script>
  <script src="https://wzrd.in/standalone/libp2p-websockets@0.14.0"></script>
  <script src="https://wzrd.in/standalone/libp2p-webrtc-star@0.20.1"></script>
  <script src="https://wzrd.in/standalone/libp2p-bootstrap@0.12.1"></script>
  <script src="https://wzrd.in/standalone/libp2p-noise@2.0.1"></script>
  <script src="https://wzrd.in/standalone/libp2p-mplex@0.10.1"></script>
  <script src="https://wzrd.in/standalone/it-pipe@1.1.0"></script>
  <script type="module">
    import {tap,collect} from 'https://cdn.jsdelivr.net/npm/streaming-iterables@5.0.3/dist/index.mjs';

    window.addEventListener('load', async () => {
      // Create our libp2p node
      const libp2p = await window.libp2p.create({
        addresses: {
          // Add the signaling server address, along with our PeerId to our multiaddrs list
          // libp2p will automatically attempt to dial to the signaling server so that it can
          // receive inbound connections from other peers
          listen: [
            '/dns4/webrtc-star.dist.pub/tcp/443/wss/p2p-webrtc-star',
          ]
        },
        modules: {
          transport: [window.libp2pWebsockets, window.libp2pWebrtcStar],
          connEncryption: [window.libp2pNoise.NOISE],
          streamMuxer: [window.libp2pMplex],
        },
      })

      // UI elements
      const status = document.getElementById('status')

      function log(txt) {
        console.info(txt)
      }

      // Listen for new connections to peers
      libp2p.connectionManager.on('peer:connect', (connection) => {
        log(`Connected to ${connection.remotePeer.toB58String()}`)
      })

      // Listen for peers disconnecting
      libp2p.connectionManager.on('peer:disconnect', (connection) => {
        log(`Disconnected from ${connection.remotePeer.toB58String()}`)
      })

      await libp2p.start()
      window.p2pNode = libp2p;

      // logic
      p2pNode.handle('/echo', async ({connection, stream}) => {
        await itPipe(
          stream.source,
          tap((msg) => {log(`receive from peer: ${connection.remoteAddr.toString()} content: ${msg}`)}),
          collect
        )
      })

      status.innerText = `libp2p started!: ${p2pNode.peerId.toB58String()}`
      log(`My id is ${p2pNode.peerId}`)
      log(`My id is ${p2pNode.peerId.toB58String()}`)
      log(`I can use ${p2pNode.multiaddrs.length} transports to communicate`)
      for (const item of p2pNode.multiaddrs) {
        log(`One is ${item.toString()}`)
      }
    })

    window.dailing = async function (peerId, content) {
      const connection = await p2pNode.dial(`/dns4/webrtc-star.dist.pub/tcp/443/wss/p2p-webrtc-star/p2p/${peerId}`)
      const stream = await connection.newStream('/echo')
      await itPipe(
        [content],
        stream.stream,
      )
    }
  </script>
{% endblock %}
